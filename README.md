<p align="center">
    <a href="http://www.serendipityhq.com" target="_blank">
        <img style="max-width: 350px" src="http://www.serendipityhq.com/assets/open-source-projects/Logo-SerendipityHQ-Icon-Text-Purple.png">
    </a>
</p>

<h1 align="center">Serendipity HQ Users Bundle</h1>
<p align="center">Helps managing users in Symfony apps.</p>
<p align="center">
    <a href="https://github.com/Aerendir/bundle-users/releases"><img src="https://img.shields.io/packagist/v/serendipity_hq/bundle-users.svg?style=flat-square"></a>
    <a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/license-MIT-brightgreen.svg?style=flat-square"></a>
    <a href="https://github.com/Aerendir/bundle-users/releases"><img src="https://img.shields.io/packagist/php-v/serendipity_hq/bundle-users?color=%238892BF&style=flat-square&logo=php" /></a>
    <a title="Tested with Symfony ^5.1" href="https://github.com/Aerendir/bundle-aws-ses-monitor/actions?query=branch%3Adev"><img title="Tested with Symfony ^5.1" src="https://img.shields.io/badge/Symfony-%5E5.1-333?style=flat-square&logo=symfony" /></a>
</p>

## Current Status

[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=coverage)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Maintainability Rating](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=sqale_rating)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=alert_status)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Reliability Rating](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=reliability_rating)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Security Rating](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=security_rating)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Technical Debt](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=sqale_index)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)
[![Vulnerabilities](https://sonarcloud.io/api/project_badges/measure?project=Aerendir_bundle-users&metric=vulnerabilities)](https://sonarcloud.io/dashboard?id=Aerendir_bundle-users)

[![Phan](https://github.com/Aerendir/bundle-users/workflows/Phan/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![PHPStan](https://github.com/Aerendir/bundle-users/workflows/PHPStan/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![PSalm](https://github.com/Aerendir/bundle-users/workflows/PSalm/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![PHPUnit](https://github.com/Aerendir/bundle-users/workflows/PHPunit/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![Composer](https://github.com/Aerendir/bundle-users/workflows/Composer/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![PHP CS Fixer](https://github.com/Aerendir/bundle-users/workflows/PHP%20CS%20Fixer/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)
[![Rector](https://github.com/Aerendir/bundle-users/workflows/Rector/badge.svg)](https://github.com/Aerendir/bundle-users/actions?query=branch%3Adev)

## Features

Provides some utilities to make easier the management of users in Symfony applications, on top of Symfony's built-in management of users.

To use this bundle, first [implement management of users following the Symfony's documentation](https://symfony.com/doc/current/security.html), then use this bundle to make some operations easier.

<hr />
<h3 align="center">
    <b>Do you like this bundle?</b><br />
    <b><a href="#js-repo-pjax-container">LEAVE A &#9733;</a></b>
</h3>
<p align="center">
    or run<br />
    <code>composer global require symfony/thanks && composer thanks</code><br />
    to say thank you to all libraries you use in your current project, this included!
</p>
<hr />

# Documentation

The starting point is always the Symfony's documentation.

- [Bootstrapping users management in your app](https://symfony.com/doc/current/security.html)
- [How to build a login form](https://symfony.com/doc/current/security/form_login_setup.html)

Once you have configured the `UserInterface` entity, configured the security of your app and built the login form, it's time to create your first user, even befre you build the registration form.

To make users management easier, `SerendipityHQ Users Bundle` provides a command `shq:users:create` that permits to create users from the command line.

It works almost out of the box: you only need to tweak just a bit the entity automaticaly generated by Symfony.

## Using the `shq:users:create` command

This command is very useful as it permits you to create users in your application before you have created the registration form.

This way you can immediately test the login functionality, but can also automate some tasks in your app, like resetting it in dev environment, without having to create a new user each time from the registration form.

To use the command, you have to do one simple thing: implement the `HasPlainPasswordInterface` and it trait in your `UserInterface` entity.

The `HasPlainPasswordInterface` makes possible to get a series of advantages: we will see them later.

For the moment be sure that you will NEVER save the plain password in the database: it is only useful during the life cycle of a `UserInterface` objects and permits to your app to implement some basic features.

For the moment, lets implement the interface and the trait.

1. Open you `UserInterface` entity (it is typically in `src/App/Entity/User.php`)
2. implement the interface `\SerendipityHQ\Bundle\UsersBundle\Property\HasPlainPasswordInterface`
3. Use the trait `SerendipityHQ\Bundle\UsersBundle\Property\HasPlainPasswordTrait`

After these modifications, your entity should appear like this:

```diff
<?php

declare(strict_types = 1);

/*
 * This file is part of Trust Back Me.
 *
 * Copyright (c) Adamo Aerendir Crespi <hello@aerendir.me>.
 *
 * This code is to consider private and non disclosable to anyone for whatever reason.
 * Every right on this code is reserved.
 *
 * For the full copyright and license information, please view the LICENSE file that
 * was distributed with this source code.
 */

namespace App\Entity;

use App\Repository\UserRepository;
use Doctrine\ORM\Mapping as ORM;
+ use SerendipityHQ\Bundle\UsersBundle\Property\HasPlainPasswordInterface;
+ use SerendipityHQ\Bundle\UsersBundle\Property\HasPlainPasswordTrait;
use Symfony\Component\Security\Core\User\UserInterface;

/**
 * @ORM\Entity(repositoryClass=UserRepository::class)
 * @ORM\Table(name="tbme_users")
 */
+ class User implements UserInterface, HasPlainPasswordInterface
{
+    use HasPlainPasswordTrait;

    // Here the remaining code of your entity
    // ...
}
```

Now create your first user using the command line:

    Aerendir@SerendipityHQ % bin/console shq:users:create Aerendir 1234

    Create user
    ===========

    Password for user Aerendir: 1234


     [OK] User Aerendir created.


`Aerendir` (the first argument), is the value of the primary property (the one set in the file `config/packages/security.yaml`, in `security.providers.[your_user_provider].entity.property`);
`1234` (the second argument), instead, is the password to assign to the user.

You are ready to test the login of your app: go to `http://your_app_url/login` and provide the credentials of the user you have just created.

Now that your login works, we can go further better understanding the purpose of `HasPlainPasswordInterface`.

## The purpose of `HasPlainPasswordINterface`

Implement `HasPlainPassword` and `use HasPlainPasswordTrait`.

This is will activate the Doctrine listener that will automatically encode the passwords properly.

- [How to add "Remember me" functionality](https://symfony.com/doc/current/security/remember_me.html)

- Installation of the SHQUsersBundle
- The `UsersManager` (provided by SHQUsersBundle)
- Events (The events triggered by the bundle: they are in src/Events)
- Commands (Explanation of the commands available) (How to extend commands)
- Creating a register form
- Creating a login form
- Creating a password reset form

## Creating a User with the manager

Method `create()` dispatches an event `UserCreatedEvent`.

You can listen for it and, if you like, you can set `UserCreatedEvent::stopPropagation()`.

If `true === UserCreatedEvent::isPropagationStopped()`, then the manager will not persist the user in the database, but will anyway return it.

This way you can decide what to do: create a new user, persist it by yourself, etc.

The manager will never call `EntityManager::flush()`: it is always your responsibility to call it and decide if and when to do so.

The method `UserInterface::eraseCredentials()` is never called by the bundle: it is a responsibility of yours as we don't know if you need them one more time (for example, to send an email to the registered user with the plain passowrd).

## Creating a registration form

When using the make command from Symfony, the generated form type has a field `plainPassword` that has the option `mapped = false`.

Implement the trait `HasPlainPassword` in the `User` entity and then remove the option from the form type.

This way, the `User` entity will have a field `plainPassword` provided by the trait, the form will bind the form field to this property and the Doctrine listener will automatically encode the password.

Also, modify the controller to not encode the password anymore.

## How to create a command to manage users



<hr />
<h3 align="center">
    <b>Do you like this bundle?</b><br />
    <b><a href="#js-repo-pjax-container">LEAVE A &#9733;</a></b>
</h3>
<p align="center">
    or run<br />
    <code>composer global require symfony/thanks && composer thanks</code><br />
    to say thank you to all libraries you use in your current project, this included!
</p>
<hr />
